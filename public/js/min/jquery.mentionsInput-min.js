!function($,e,t){var n={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},i={triggerChar:"@",onDataRequest:$.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!0,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:e.template('<div class="mentions-input-box"></div>'),autocompleteList:e.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:e.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:e.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:e.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:e.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:e.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:e.template("<strong><span><%= value %></span></strong>")}},a={htmlEncode:function(t){return e.escape(t)},regexpEncode:function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}},o=function(t){function o(){S=$(R),"true"!==S.attr("data-mentions-input")&&(k=S.parent(),M=$(t.templates.wrapper()),S.wrapAll(M),M=k.find("> div.mentions-input-box"),S.attr("data-mentions-input","true"),S.bind("keydown",C),S.bind("keypress",y),S.bind("click",g),S.bind("blur",v),navigator.userAgent.indexOf("MSIE 8")>-1?S.bind("propertychange",x):S.bind("input",x),t.elastic&&S.elastic())}function r(){L=$(t.templates.autocompleteList()),L.appendTo(M),L.delegate("li","mousedown",h)}function l(){O=$(t.templates.mentionsOverlay()),O.prependTo(M)}function s(){var n=p();e.each(D,function(e){var i=t.templates.mentionItemSyntax(e);n=n.replace(new RegExp(a.regexpEncode(e.value),"g"),i)});var i=a.htmlEncode(n);e.each(D,function(n){var o=e.extend({},n,{value:a.htmlEncode(n.value)}),r=t.templates.mentionItemSyntax(o),l=t.templates.mentionItemHighlight(o);i=i.replace(new RegExp(a.regexpEncode(r),"g"),l)}),i=i.replace(/\n/g,"<br />"),i=i.replace(/ {2}/g,"&nbsp; "),S.data("messageText",n),S.trigger("updated"),O.find("div").html(i)}function c(){P=[]}function d(){var t=p();D=e.reject(D,function(e,n){return!e.value||-1==t.indexOf(e.value)}),D=e.compact(D)}function u(n){var i=p(),o=new RegExp("\\"+t.triggerChar+j,"gi");o.exec(i);var r=o.lastIndex-j.length-1,l=o.lastIndex,d=i.substr(0,r),u=i.substr(l,i.length),m=(d+n.value).length+1;e.find(D,function(e){return e.id==n.id})||D.push(n),c(),j="",E();var f=d+n.value+" "+u;S.val(f),S.trigger("mention"),s(),S.focus(),a.setCaratPosition(S[0],m)}function p(){return $.trim(S.val())}function m(e){var t,n,i,a,o,r,l,s,c,d,u;if((c=e[0])&&$(c).is("textarea")&&null!=c.selectionEnd){for(l={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},s=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"],d=0,u=s.length;u>d;d++)o=s[d],l[o]=$(c).css(o);return i=document.createElement("div"),$(i).css(l),$(c).after(i),n=document.createTextNode(c.value.substring(0,c.selectionEnd)),t=document.createTextNode(c.value.substring(c.selectionEnd)),a=document.createElement("span"),a.innerHTML="&nbsp;",i.appendChild(n),i.appendChild(a),i.appendChild(t),i.scrollTop=c.scrollTop,r=$(a).position(),$(i).remove(),r}}function f(){var e=$(S).offset().top,t=$("body").offset().top,n=$(window).scrollTop();n>e&&$(window).scrollTop(e-t)}function h(e){var t=$(this),n=H[t.attr("data-uid")];return u(n),f(),!1}function g(e){c()}function v(e){E()}function x(n){s(),d();var i=e.lastIndexOf(P,t.triggerChar);i>-1&&(j=P.slice(i+1).join(""),j=a.rtrim(j),e.defer(e.bind(I,this,j)))}function y(e){if(e.keyCode!==n.BACKSPACE){var t=String.fromCharCode(e.which||e.keyCode);P.push(t)}}function C(t){if(t.keyCode===n.LEFT||t.keyCode===n.RIGHT||t.keyCode===n.HOME||t.keyCode===n.END)return e.defer(c),void(navigator.userAgent.indexOf("MSIE 9")>-1&&e.defer(s));if(t.keyCode===n.BACKSPACE)return void(P=P.slice(0,-1+P.length));if(!L.is(":visible"))return!0;switch(t.keyCode){case n.UP:case n.DOWN:var i=null;return i=t.keyCode===n.DOWN?N&&N.length?N.next():L.find("li").first():$(N).prev(),i.length&&w(i),!1;case n.RETURN:case n.TAB:if(N&&N.length)return N.trigger("mousedown"),!1}return!0}function E(){N=null,L.empty().hide()}function w(e){e.addClass(t.classes.autoCompleteItemActive),e.siblings().removeClass(t.classes.autoCompleteItemActive),N=e}function b(n,i){if(L.show(),!t.allowRepeat){var o=e.pluck(D,"value");i=e.reject(i,function(t){return e.include(o,t.name)})}if(!i.length)return void E();L.empty();var r=$("<ul>").appendTo(L).hide();e.each(i,function(i,o){var l=e.uniqueId("mention_");H[l]=e.extend({},i,{value:i.name});var s=$(t.templates.autocompleteListItem({id:a.htmlEncode(i.id),display:a.htmlEncode(i.name),type:a.htmlEncode(i.type),content:a.highlightTerm(a.htmlEncode(i.display?i.display:i.name),n)})).attr("data-uid",l);if(0===o&&w(s),t.showAvatars){var c;c=$(i.avatar?t.templates.autocompleteListItemAvatar({avatar:i.avatar}):t.templates.autocompleteListItemIcon({icon:i.icon})),c.prependTo(s)}s=s.appendTo(r)}),L.show(),t.onCaret&&T(L,S),r.show()}function I(e){e&&e.length&&e.length>=t.minChars?t.onDataRequest.call(this,"search",e,function(t){b(e,t)}):E()}function T(e,t){var n=m(t),i=parseInt(t.css("line-height"),10)||18;e.css("width","15em"),e.css("left",n.left),e.css("top",i+n.top);var a=t.offset().left+t.width(),o=e.offset().left+e.width();o>=a&&e.css("left",Math.abs(e.position().left-(o-a)))}function A(e){D=[];for(var n=a.htmlEncode(e),i=new RegExp("("+t.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),o,r=n;null!=(o=i.exec(n));)r=r.replace(o[0],o[1]+o[2]),D.push({id:o[4],type:o[3],value:o[2],trigger:o[1]});S.val(r),s()}var R,S,k,L,M,O,N,D=[],H={},P=[],j="";return t=$.extend(!0,{},i,t),{init:function(e){R=e,o(),r(),l(),A(t.defaultValue),t.prefillMention&&u(t.prefillMention)},val:function(t){e.isFunction(t)&&t.call(this,D.length?S.data("messageText"):p())},reset:function(){A()},getMentions:function(t){e.isFunction(t)&&t.call(this,D)}}};$.fn.mentionsInput=function(t,n){var i=arguments;return"object"!=typeof t&&t||(n=t),this.each(function(){var a=$.data(this,"mentionsInput")||$.data(this,"mentionsInput",new o(n));return e.isFunction(a[t])?a[t].apply(this,Array.prototype.slice.call(i,1)):"object"!=typeof t&&t?void $.error("Method "+t+" does not exist"):a.init.call(this,this)})}}(jQuery,_);